<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RICOTTA ADMIN</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      background: #F9F8F6;
      font-family: "Playfair Display", serif;
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center">

  <!-- LOGIN SCREEN -->
  <div id="login-screen" class="w-full max-w-sm p-8 bg-white shadow-xl border border-gray-200 rounded-lg">
    <h1 class="text-3xl text-center mb-6 tracking-[0.2em]">ADMIN</h1>

    <input id="admin-password" type="password"
           placeholder="Enter password"
           class="w-full p-3 border border-gray-300 rounded mb-4">

    <button onclick="loginAdmin()"
            class="w-full bg-black text-white py-3 rounded tracking-[0.2em] hover:bg-gray-800">
      LOGIN
    </button>

    <p id="login-error" class="text-red-600 text-center mt-3 hidden">
      Wrong Password
    </p>
  </div>

  <!-- DASHBOARD -->
  <div id="admin-panel" class="hidden w-full p-10">

    <h1 class="text-5xl mb-10 text-center tracking-[0.2em]">RICOTTA ADMIN</h1>

    <!-- SUMMARY BOXES -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12" id="summary-boxes"></div>

    <!-- ORDERS -->
    <div class="bg-white p-8 rounded-lg shadow-xl border border-gray-200">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl tracking-[0.1em]">Paid Orders From Square</h2>
        <button onclick="loadOrders()"
                class="px-5 py-2 bg-black text-white rounded tracking-widest hover:bg-gray-800">
          Refresh
        </button>
      </div>

      <div id="orders-list" class="space-y-4">
        <div class="text-gray-500 italic">Loading…</div>
      </div>
    </div>

  </div>

<script>
/* ----------------------- AUTH ------------------------- */
function loginAdmin() {
  const pass = document.getElementById("admin-password").value.trim();

  // סיסמה (תשנה למה שאתה רוצה)
  if (pass === "ricotta999") {
    document.getElementById("login-screen").classList.add("hidden");
    document.getElementById("admin-panel").classList.remove("hidden");
    initDashboard();
  } else {
    document.getElementById("login-error").classList.remove("hidden");
  }
}

/* ----------------------- CONFIG ------------------------ */

// כמה סופגניות ליום
const DAILY_LIMIT = 250;

// Square Production Token (ה־Access Token שלך)
const SQUARE_TOKEN = "EAAAl4mJqoabKy44ioRVy_WywmHMMYc5iFmOaUVSBdqCl2ngmFM3EhzowsnvR8o4"; // ← להחליף לטוקן האמיתי
const SQUARE_LOCATION_ID = "L54AH5T8V5HVN";

// טווח הימים של חנוכה
const DAYS = [
  "2025-12-15","2025-12-16","2025-12-17","2025-12-18",
  "2025-12-19","2025-12-20","2025-12-21","2025-12-22"
];

/* ----------------------- GLOBAL CACHE ------------------------ */
let ORDERS_CACHE = [];

/* ----------------------- INIT ------------------------ */
async function initDashboard() {
  try {
    await loadAllOrdersFromSquare();
    renderDailySummary();
    renderOrdersList();
  } catch (err) {
    console.error("Init error:", err);
    const box = document.getElementById("summary-boxes");
    if (box) {
      box.innerHTML = `<div class="col-span-3 text-center text-red-600">
        Error loading data from Square. Check token / permissions.
      </div>`;
    }
  }
}

/* ----------------------- LOAD ALL ORDERS (ONCE) ------------------------ */
async function loadAllOrdersFromSquare() {
  // טוען הזמנות בטווח גדול (כל חנוכה) לפי Orders API
  // מסנן ל־COMPLETED בלבד
  const body = {
    location_ids: [SQUARE_LOCATION_ID],
    query: {
      filter: {
        state_filter: {
          states: ["COMPLETED"]
        },
        date_time_filter: {
          // מחפשים לפי זמן יצירת ההזמנה – זה רק פילטר ראשוני
          created_at: {
            start_at: "2025-12-14T00:00:00-05:00",
            end_at:   "2025-12-23T23:59:59-05:00"
          }
        }
      }
    }
  };

  const res = await fetch("https://connect.squareup.com/v2/orders/search", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${SQUARE_TOKEN}`,
      "Square-Version": "2025-01-15",
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });

  const data = await res.json();
  if (!res.ok) {
    console.error("Square orders error:", data);
    throw new Error(data.errors?.[0]?.detail || "Failed to load orders");
  }

  ORDERS_CACHE = data.orders || [];
}

/* ----------------------- HELPER: COUNT DONUTS BY PICKUP DATE ------------------------ */
function buildCountsByPickupDate() {
  // נחזיר map של { '2025-12-18': 132, ... }
  const map = {};

  for (const order of ORDERS_CACHE) {
    const fulfill = (order.fulfillments && order.fulfillments[0]) || null;
    const pickupAt = fulfill?.pickup_details?.pickup_at || null;
    if (!pickupAt) continue;

    // pickupAt בפורמט: 2025-12-18T10:00:00-05:00 → לוקחים רק yyyy-mm-dd
    const pickupDate = pickupAt.slice(0, 10);

    let donutsInOrder = 0;
    for (const li of order.line_items || []) {
      if (li.name === "Pickup Details") continue; // לא סופרים שורת מידע
      const q = parseInt(li.quantity || "0", 10);
      if (!isNaN(q)) donutsInOrder += q;
    }

    if (!map[pickupDate]) map[pickupDate] = 0;
    map[pickupDate] += donutsInOrder;
  }

  return map;
}

/* ----------------------- RENDER DAILY SUMMARY ------------------------ */
function renderDailySummary() {
  const countsMap = buildCountsByPickupDate();
  const boxContainer = document.getElementById("summary-boxes");
  boxContainer.innerHTML = "";

  DAYS.forEach((date) => {
    const used = countsMap[date] || 0;
    const remaining = Math.max(DAILY_LIMIT - used, 0);

    boxContainer.innerHTML += `
      <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 text-center">
        <h3 class="text-xl font-semibold mb-2">${date}</h3>
        <p class="text-3xl font-bold">${used} / ${DAILY_LIMIT}</p>
        <p class="text-gray-500 mt-2">${remaining} Remaining</p>
      </div>
    `;
  });
}

/* ----------------------- RENDER ORDERS LIST ------------------------ */
function renderOrdersList() {
  const container = document.getElementById("orders-list");
  container.innerHTML = "";

  if (!ORDERS_CACHE.length) {
    container.innerHTML = `<div class="text-gray-500 italic">No completed orders yet.</div>`;
    return;
  }

  // נסדר מהחדש לישן
  const sorted = [...ORDERS_CACHE].sort((a, b) =>
    (b.closed_at || b.created_at || "").localeCompare(a.closed_at || a.created_at || "")
  );

  sorted.forEach((order) => {
    const fulfill = (order.fulfillments && order.fulfillments[0]) || null;
    const pickupAt = fulfill?.pickup_details?.pickup_at || "";
    const pickupDate = pickupAt ? pickupAt.slice(0, 10) : "N/A";
    const pickupTime = pickupAt ? pickupAt.slice(11, 16) : "";

    let donutsInOrder = 0;
    (order.line_items || []).forEach((li) => {
      if (li.name === "Pickup Details") return;
      const q = parseInt(li.quantity || "0", 10);
      if (!isNaN(q)) donutsInOrder += q;
    });

    const total = order.total_money
      ? (order.total_money.amount / 100).toFixed(2)
      : "0.00";

    container.innerHTML += `
      <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
        <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-2">
          <div>
            <p class="font-bold text-sm md:text-base">Order ID: ${order.id}</p>
            <p class="text-sm text-gray-600">
              Pickup: ${pickupDate} ${pickupTime ? "(" + pickupTime + ")" : ""}
            </p>
            <p class="text-sm text-gray-600">
              Donuts: ${donutsInOrder}
            </p>
          </div>
          <div class="text-right">
            <p class="font-bold text-lg">$${total}</p>
            <p class="text-xs text-gray-500 mt-1">
              Created: ${order.created_at || ""}
            </p>
          </div>
        </div>
      </div>
    `;
  });
}

/* ----------------------- REFRESH BUTTON ------------------------ */
async function loadOrders() {
  const container = document.getElementById("orders-list");
  container.innerHTML = "<div class='text-gray-500 italic'>Loading…</div>";
  try {
    await loadAllOrdersFromSquare();
    renderDailySummary();
    renderOrdersList();
  } catch (err) {
    console.error("Refresh error:", err);
    container.innerHTML = "<div class='text-red-600'>Error reloading orders.</div>";
  }
}
</script>


</body>
</html>
