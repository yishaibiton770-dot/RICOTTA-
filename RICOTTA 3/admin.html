<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RICOTTA ADMIN</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      background: #F9F8F6;
      font-family: "Playfair Display", serif;
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center">

  <!-- LOGIN SCREEN -->
  <div id="login-screen" class="w-full max-w-sm p-8 bg-white shadow-xl border border-gray-200 rounded-lg">
    <h1 class="text-3xl text-center mb-6 tracking-[0.2em]">ADMIN</h1>

    <input id="admin-password" type="password"
           placeholder="Enter password"
           class="w-full p-3 border border-gray-300 rounded mb-4">

    <button onclick="loginAdmin()"
            class="w-full bg-black text-white py-3 rounded tracking-[0.2em] hover:bg-gray-800">
      LOGIN
    </button>

    <p id="login-error" class="text-red-600 text-center mt-3 hidden">
      Wrong Password
    </p>
  </div>

  <!-- DASHBOARD -->
  <div id="admin-panel" class="hidden w-full p-10">

    <h1 class="text-5xl mb-10 text-center tracking-[0.2em]">RICOTTA ADMIN</h1>

    <!-- SUMMARY BOXES -->
    <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-4 gap-8 mb-12" id="summary-boxes"></div>

    <!-- ORDERS -->
    <div class="bg-white p-8 rounded-lg shadow-xl border border-gray-200 max-w-5xl mx-auto">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-6">
        <h2 class="text-3xl tracking-[0.1em]">Paid Orders From Square</h2>
        <button onclick="loadOrders()"
                class="px-5 py-2 bg-black text-white rounded tracking-widest hover:bg-gray-800 text-sm">
          Refresh
        </button>
      </div>

      <div id="orders-list" class="space-y-4">
        <div class="text-gray-500 italic">Loading…</div>
      </div>
    </div>

  </div>

<script>
/* ----------------------- AUTH ------------------------- */
function loginAdmin() {
  const pass = document.getElementById("admin-password").value.trim();

  // סיסמה (תשנה למה שאתה רוצה)
  if (pass === "ricotta999") {
    document.getElementById("login-screen").classList.add("hidden");
    document.getElementById("admin-panel").classList.remove("hidden");
    initDashboard();
  } else {
    document.getElementById("login-error").classList.remove("hidden");
  }
}

/* ----------------------- GLOBAL DATA ------------------------ */
let ADMIN_DATA = {
  daysSummary: [],
  orders: []
};

/* ----------------------- INIT ------------------------ */
async function initDashboard() {
  const boxes = document.getElementById("summary-boxes");
  const ordersList = document.getElementById("orders-list");

  boxes.innerHTML = `
    <div class="col-span-4 text-center text-gray-500 italic">
      Loading data from Square…
    </div>
  `;
  ordersList.innerHTML = `<div class="text-gray-500 italic">Loading…</div>`;

  try {
    await fetchAdminData();
    renderDailySummary();
    renderOrdersList();
  } catch (err) {
    console.error("Init error:", err);
    boxes.innerHTML = `
      <div class="col-span-4 text-center text-red-600">
        Error loading data from server. Check Netlify function / env.
      </div>
    `;
    ordersList.innerHTML = `
      <div class="text-red-600">
        Error loading orders.
      </div>
    `;
  }
}

/* ----------------------- FETCH FROM NETLIFY FUNCTION ------------------------ */
async function fetchAdminData() {
  const res = await fetch("/.netlify/functions/admin-orders");
  const data = await res.json().catch(() => ({}));

  if (!res.ok) {
    console.error("Admin function error:", data);
    throw new Error(data.error || "Failed to load admin data");
  }

  ADMIN_DATA = {
    daysSummary: data.daysSummary || [],
    orders: data.orders || []
  };
}

/* ----------------------- RENDER DAILY SUMMARY ------------------------ */
function renderDailySummary() {
  const boxContainer = document.getElementById("summary-boxes");
  boxContainer.innerHTML = "";

  if (!ADMIN_DATA.daysSummary.length) {
    boxContainer.innerHTML = `
      <div class="col-span-4 text-center text-gray-500 italic">
        No orders yet.
      </div>
    `;
    return;
  }

  ADMIN_DATA.daysSummary.forEach((day) => {
    const used = day.used || 0;
    const limit = day.limit || 250;
    const remaining = day.remaining != null ? day.remaining : Math.max(limit - used, 0);

    boxContainer.innerHTML += `
      <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 text-center">
        <h3 class="text-lg font-semibold mb-2 tracking-[0.15em]">${day.date}</h3>
        <p class="text-3xl font-bold">${used} / ${limit}</p>
        <p class="text-gray-500 mt-2">${remaining} Remaining</p>
      </div>
    `;
  });
}

/* ----------------------- RENDER ORDERS LIST ------------------------ */
function renderOrdersList() {
  const container = document.getElementById("orders-list");
  container.innerHTML = "";

  const orders = ADMIN_DATA.orders || [];
  if (!orders.length) {
    container.innerHTML = `<div class="text-gray-500 italic">No completed orders yet.</div>`;
    return;
  }

  const sorted = [...orders].sort((a, b) => {
    const aKey = (a.pickupDate || "") + "T" + (a.pickupTime || "");
    const bKey = (b.pickupDate || "") + "T" + (b.pickupTime || "");
    return bKey.localeCompare(aKey);
  });

  sorted.forEach((order) => {
    const total =
      order.totalCents != null
        ? (order.totalCents / 100).toFixed(2)
        : "0.00";

    const pickupDate = order.pickupDate || "N/A";
    const pickupTime = order.pickupTime ? `(${order.pickupTime})` : "";
    const customerName = order.customerName || "";
    const customerPhone = order.customerPhone || "";
    const customerEmail = order.customerEmail || "";

    container.innerHTML += `
      <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
        <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-3">
          <div class="space-y-1">
            <p class="font-bold text-sm md:text-base">Order ID: ${order.id}</p>
            <p class="text-sm text-gray-700">
              Pickup: <span class="font-medium">${pickupDate} ${pickupTime}</span>
            </p>
            <p class="text-sm text-gray-700">
              Donuts: <span class="font-medium">${order.donuts}</span>
            </p>
            ${
              customerName || customerPhone || customerEmail
                ? `<div class="mt-2 text-xs text-gray-600 space-y-1">
                    ${customerName ? `<div><span class="font-semibold">Name:</span> ${customerName}</div>` : ""}
                    ${customerPhone ? `<div><span class="font-semibold">Phone:</span> ${customerPhone}</div>` : ""}
                    ${customerEmail ? `<div><span class="font-semibold">Email:</span> ${customerEmail}</div>` : ""}
                  </div>`
                : ""
            }
          </div>
          <div class="text-right">
            <p class="font-bold text-lg">$${total}</p>
            <p class="text-xs text-gray-500 mt-1">
              Created: ${order.createdAt || ""}
            </p>
          </div>
        </div>
      </div>
    `;
  });
}

/* ----------------------- REFRESH BUTTON ------------------------ */
async function loadOrders() {
  const container = document.getElementById("orders-list");
  container.innerHTML = "<div class='text-gray-500 italic'>Loading…</div>";
  try {
    await fetchAdminData();
    renderDailySummary();
    renderOrdersList();
  } catch (err) {
    console.error("Refresh error:", err);
    container.innerHTML = "<div class='text-red-600'>Error reloading orders.</div>";
  }
}
</script>

</body>
</html>
